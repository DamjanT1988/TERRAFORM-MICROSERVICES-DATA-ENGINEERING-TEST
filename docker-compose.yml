services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: openbank
    ports:
      - "5432:5432"

  minio:
    image: minio/minio:RELEASE.2024-08-17T01-24-54Z
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"

  rabbitmq:
    image: rabbitmq:3.13-management
    ports:
      - "5672:5672"
      - "15672:15672"

  ingest:
    build: ./services/ingest
    environment:
      INGEST_MINIO_ENDPOINT: minio:9000
      INGEST_MINIO_ACCESS_KEY: minioadmin
      INGEST_MINIO_SECRET_KEY: minioadmin
      INGEST_MINIO_BUCKET: raw-transactions
      INGEST_RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
    ports:
      - "8001:8001"
    depends_on:
      - minio
      - rabbitmq

  transform:
    build: ./services/transform
    environment:
      TRANSFORM_MINIO_ENDPOINT: minio:9000
      TRANSFORM_MINIO_ACCESS_KEY: minioadmin
      TRANSFORM_MINIO_SECRET_KEY: minioadmin
      TRANSFORM_MINIO_BUCKET: raw-transactions
      TRANSFORM_RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      TRANSFORM_DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres:5432/openbank
      PYTHONPATH: /app
    command: ["sh", "-c", "alembic upgrade head && python -m app.worker"]
    depends_on:
      - postgres
      - minio
      - rabbitmq

  api:
    build: ./services/api
    environment:
      API_DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres:5432/openbank
      API_API_KEY: local-dev-key
    ports:
      - "8002:8002"
    depends_on:
      - postgres
